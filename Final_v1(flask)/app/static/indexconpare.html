<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta and Title -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ShadowByte - Suspect Visualization</title>
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Styles -->
    <style>
        /* [Existing CSS styles remain unchanged] */
        /* ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar (Left Side) -->
        <div class="sidebar">
            <h1><i class="fas fa-user-secret"></i> Suspect Network</h1>
            <div class="section overview-frame">
                <h2>Overall Details</h2>
                <p>Total Suspects: <span id="total-suspects">0</span></p>
                <p>Total Connections: <span id="total-connections">0</span></p>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <input id="search" placeholder="Search in the graph..." type="text" />
                <div class="header-right">
                    <div class="buttons">
                        <button id="add-node"><i class="fas fa-plus"></i> Add Suspect</button>
                        <button id="delete-node"><i class="fas fa-trash"></i> Delete Suspect</button>
                    </div>
                </div>
            </div>
            <div class="graph">
                <div id="cy"></div>
            </div>
            <div class="footer">
                <a href="#"><i class="fas fa-server"></i> API requests: <span id="api-requests">0</span></a>
                <div>
                    <a href="#"><i class="fas fa-book"></i> Documentation</a> |
                    <a href="#"><i class="fas fa-code"></i> API</a> |
                    <a href="#"><i class="fas fa-comment"></i> Send feedback</a>
                </div>
            </div>
        </div>
        <!-- Profile Icon -->
        <i class="fas fa-user-circle profile-icon" id="profile-icon"></i>
        <!-- Tool Panel (Right Side) -->
        <div class="tool-panel">
            <!-- Tool panel content -->
            <div class="category">
                <h2><i class="fas fa-tools"></i> Tools</h2>
                <div class="tool-list">
                    <button id="add-connection"><i class="fas fa-link"></i> Add Connection</button>
                    <button id="analyze-network"><i class="fas fa-search"></i> Analyze Network</button>
                    <button id="export-data"><i class="fas fa-file-export"></i> Export Data</button>
                    <button id="import-data"><i class="fas fa-file-import"></i> Import Data</button>
                    <button id="settings"><i class="fas fa-cog"></i> Settings</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-database"></i> Data Collection</h2>
                <div class="tool-list">
                    <button id="web-scraping"><i class="fas fa-globe"></i> Web Scraping</button>
                    <button id="api-integration"><i class="fas fa-plug"></i> API Integration</button>
                    <button id="social-media-scraping"><i class="fas fa-hashtag"></i> Social Media Scraping</button>
                    <button id="dork-suspect"><i class="fas fa-magnifying-glass"></i> Dork Suspect</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-chart-bar"></i> Analytics</h2>
                <div class="tool-list">
                    <button id="generate-reports"><i class="fas fa-file-alt"></i> Generate Reports</button>
                    <button id="statistics"><i class="fas fa-chart-pie"></i> Statistics</button>
                    <button id="trend-analysis"><i class="fas fa-chart-line"></i> Trend Analysis</button>
                </div>
            </div>
            <div class="category">
                <h2><i class="fas fa-user-shield"></i> Security</h2>
                <div class="tool-list">
                    <button id="user-management"><i class="fas fa-users-cog"></i> User Management</button>
                    <button id="access-control"><i class="fas fa-shield-alt"></i> Access Control</button>
                    <button id="audit-logs"><i class="fas fa-clipboard-list"></i> Audit Logs</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Adding Node -->
    <div id="node-modal" class="modal">
        <div class="modal-content">
            <h2>Add Suspect</h2>
            <form id="node-form">
                <!-- Removed Suspect ID field -->
                <label for="full-name">Full Name:</label>
                <input type="text" id="full-name" name="full-name" required />
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" />
                <label for="nic">NIC:</label>
                <input type="text" id="nic" name="nic" />
                <label for="social-media">Social Media Accounts:</label>
                <input type="text" id="social-media" name="social-media" placeholder="Comma-separated usernames" />
                <div class="buttons">
                    <button type="button" class="cancel" id="node-cancel-button">Cancel</button>
                    <button type="submit" class="submit">Add Suspect</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for Node Details -->
    <div id="detail-modal" class="detail-modal">
        <div class="detail-modal-content">
            <h2>Node Details</h2>
            <!-- Suspect Details -->
            <div id="suspect-details">
                <p><span>ID:</span> <span id="detail-id"></span></p>
                <p><span>Full Name:</span> <span id="detail-fullname"></span></p>
                <p><span>Email:</span> <span id="detail-email"></span></p>
                <p><span>NIC:</span> <span id="detail-nic"></span></p>
                <p><span>Social Media:</span> <span id="detail-socialmedia"></span></p>
            </div>
            <!-- Result Details -->
            <div id="result-details" style="display: none;">
                <p><span>Headline:</span> <span id="detail-title"></span></p>
                <p><span>Link:</span> <a href="#" id="detail-link" target="_blank">View Link</a></p>
                <p><span>Date:</span> <span id="detail-snippet"></span></p>
                <p><span>Category:</span> <span id="detail-category"></span></p>
                <!-- Image Preview for Google Images -->
                <div id="image-preview" style="display: none;">
                    <img id="preview-image-full" src="" alt="Image Preview" />
                </div>
            </div>
            <div class="close-btn">
                <button id="close-detail-modal">Close</button>
            </div>
        </div>
    </div>
    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="modal">
        <div class="modal-content" id="image-preview-content">
            <h2>Image Preview</h2>
            <img id="preview-image-full" src="" alt="Image Preview" />
            <div class="close-btn">
                <button id="close-image-preview">Close</button>
            </div>
        </div>
    </div>
    <!-- Account Modal -->
    <div id="account-modal" class="account-modal">
        <div class="account-modal-content">
            <h2>Account Details</h2>
            <p><strong>Username:</strong> user123</p>
            <p><strong>Email:</strong> user@example.com</p>
            <!-- Add more account details as needed -->
            <button id="logout-button-modal">Logout</button>
        </div>
    </div>
    <!-- Modal for Dork Suspect Options -->
    <div id="dork-modal" class="modal">
        <div class="modal-content">
            <h2>Dork Suspect</h2>
            <form id="dork-form">
                <label for="search-all">Search All Name Types:</label>
                <select id="search-all" name="search-all" required>
                    <option value="">Select</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <label>Select Search Engines:</label>
                <div class="tool-list">
                    <div>
                        <input type="checkbox" id="google" name="search-engines" value="google">
                        <label for="google">Google</label>
                    </div>
                    <div>
                        <input type="checkbox" id="bing" name="search-engines" value="bing">
                        <label for="bing">Bing</label>
                    </div>
                </div>
                <div class="buttons">
                    <button type="button" class="cancel" id="dork-cancel-button">Cancel</button>
                    <button type="submit" class="submit">Start Dorking</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal for Existing Suspect -->
    <div id="existing-suspect-modal" class="modal">
        <div class="modal-content">
            <h2>Suspect Already Exists</h2>
            <p>The suspect "<span id="existing-suspect-name"></span>" has already been scraped.</p>
            <p>Do you want to use existing data or scrape again?</p>
            <div class="buttons">
                <button id="use-existing">Use Existing Data</button>
                <button id="scrape-again">Scrape Again</button>
            </div>
        </div>
    </div>
    <!-- Polling Message -->
    <div id="polling-message" style="display: none; color: #fff; text-align: center; padding: 10px; background-color: rgba(0, 0, 0, 0.5); position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1003;">
        Scraping in progress...
    </div>

    <div id="context-menu">
        <ul>
            <li id="context-dorking">Dorking</li>
            <li id="context-delete">Delete Node</li>
        </ul>
    </div>

    <script>
        var existingSuspectName = '';
        var existingSuspectId = '';
        var dorkingSuspect = null;

        document.querySelectorAll('.tool-panel .category h2').forEach(header => {
            header.addEventListener('click', () => {
                const toolList = header.nextElementSibling;
                toolList.style.display = toolList.style.display === 'block' ? 'none' : 'block';
            });
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            var cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    /* [Existing Cytoscape styles remain unchanged] */
                    /* ... */
                ],
                elements: [],
                layout: {
                    name: 'cose',
                    padding: 10
                }
            });
    
            let apiRequestCount = 0;
    
            var addModal = document.getElementById('node-modal');
            var form = document.getElementById('node-form');
            var nodeCancelBtn = document.getElementById('node-cancel-button');
    
            var contextMenu = document.getElementById('context-menu');
            var contextDorking = document.getElementById('context-dorking');
            var contextDelete = document.getElementById('context-delete');
    
            var selectedSuspect = null;
    
            // Open modal on 'Add Node' click
            document.getElementById('add-node').addEventListener('click', function() {
                addModal.style.display = 'block';
            });
    
            // Close node modal on 'Cancel' click
            nodeCancelBtn.addEventListener('click', function() {
                addModal.style.display = 'none';
                form.reset();
            });
    
            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
    
                var fullName = document.getElementById('full-name').value.trim();
                var email = document.getElementById('email').value.trim();
                var nic = document.getElementById('nic').value.trim();
                var socialMedia = document.getElementById('social-media').value.trim();
    
                var suspectData = {
                    suspect_name: fullName,
                    email: email,
                    nic: nic,
                    social_media: socialMedia
                };
    
                fetch('/api/add-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(suspectData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
    
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: data.suspect_id,
                                label: fullName,
                                email: email || '',
                                nic: nic || '',
                                socialMedia: socialMedia || '',
                                type: 'suspect'
                            }
                        });
    
                        cy.layout({ name: 'cose', padding: 10, animate: true }).run();
    
                        document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                        document.getElementById('total-connections').innerText = cy.edges().length;
                    } else if (data.status === 'exists') {
                        existingSuspectId = data.suspect_id;
                        existingSuspectName = fullName;
                        openExistingSuspectModal(data.suspect_id, fullName);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding the suspect.');
                });
    
                addModal.style.display = 'none';
                form.reset();
            });
    
            // Delete node functionality
            document.getElementById('delete-node').addEventListener('click', function() {
                var selectedNodes = cy.$(':selected');
                if (selectedNodes.length > 0) {
                    if (confirm('Are you sure you want to delete the selected suspect(s) and all their connections?')) {
                        selectedNodes.forEach(node => {
                            var suspectId = node.id();
                            fetch('/api/delete-suspect', {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ suspect_id: suspectId })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    console.log(`Deleted suspect ID: ${suspectId}`);
                                } else {
                                    console.error(`Error deleting suspect: ${data.error}`);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
    
                            cy.remove(node);
                        });
    
                        document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                        document.getElementById('total-connections').innerText = cy.edges().length;
                    }
                } else {
                    alert('Please select a suspect to delete.');
                }
            });
    
            // Suspect detail modal elements
            var detailModal = document.getElementById('detail-modal');
            var closeDetailBtn = document.getElementById('close-detail-modal');
    
            // Image preview modal elements
            var imagePreviewModal = document.getElementById('image-preview-modal');
            var closeImagePreviewBtn = document.getElementById('close-image-preview');
    
            // Node selection and detail display
            cy.on('tap', 'node', function(evt){
                var node = evt.target;
                cy.$('node').unselect();
                node.select();
    
                var type = node.data('type');
    
                if(type === 'suspect') {
                    selectedSuspect = node.data();
    
                    document.getElementById('suspect-details').style.display = 'block';
                    document.getElementById('result-details').style.display = 'none';
    
                    document.getElementById('detail-id').innerText = node.data('id') || 'N/A';
                    document.getElementById('detail-fullname').innerText = node.data('label') || 'N/A';
                    document.getElementById('detail-email').innerText = node.data('email') || 'N/A';
                    document.getElementById('detail-nic').innerText = node.data('nic') || 'N/A';
                    document.getElementById('detail-socialmedia').innerText = node.data('socialMedia') || 'N/A';
                }
                else if(type === 'source') {
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'block';
    
                    document.getElementById('detail-title').innerText = node.data('label') || 'Source';
                    var linkElement = document.getElementById('detail-link');
                    linkElement.href = '#';
                    linkElement.innerText = 'N/A';
                    document.getElementById('detail-snippet').innerText = '';
                    document.getElementById('detail-category').innerText = node.data('category') || 'N/A';
                    document.getElementById('image-preview').style.display = 'none';
                }
                else if(type === 'result') {
                    document.getElementById('suspect-details').style.display = 'none';
                    document.getElementById('result-details').style.display = 'block';
    
                    document.getElementById('detail-title').innerText = node.data('headline') || 'N/A';
                    var linkElement = document.getElementById('detail-link');
                    linkElement.href = node.data('url') || '#';
                    linkElement.innerText = node.data('url') ? 'View Link' : 'N/A';
                    document.getElementById('detail-snippet').innerText = node.data('date') || 'N/A';
                    document.getElementById('detail-category').innerText = node.data('category') || 'N/A';
    
                    if(node.data('category') === 'google_images' && node.data('image_url')) {
                        document.getElementById('preview-image-full').src = node.data('image_url');
                        imagePreviewModal.style.display = 'block';
                    } else {
                        document.getElementById('image-preview').style.display = 'none';
                    }
                }
    
                detailModal.style.display = 'block';
            });
    
            // Close detail modal
            closeDetailBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                document.getElementById('image-preview').style.display = 'none';
            });
    
            // Close image preview modal
            closeImagePreviewBtn.addEventListener('click', function() {
                imagePreviewModal.style.display = 'none';
            });
    
            // Right-click context menu
            cy.on('cxttap', 'node', function(evt){
                var node = evt.target;
                var evtPos = evt.renderedPosition;
                contextMenu.style.display = 'block';
                contextMenu.style.left = evt.originalEvent.pageX + 'px';
                contextMenu.style.top = evt.originalEvent.pageY + 'px';
                contextMenu.currentNode = node;
            });
    
            // Handle context menu actions
            contextDorking.addEventListener('click', function() {
                var node = contextMenu.currentNode;
                if(node && node.data('type') === 'suspect') {
                    dorkingSuspect = node.data();
                    dorkModal.style.display = 'block';
                }
                contextMenu.style.display = 'none';
            });
    
            contextDelete.addEventListener('click', function() {
                var node = contextMenu.currentNode;
                if(node) {
                    if (confirm('Are you sure you want to delete this node and its connections?')) {
                        var suspectId = node.id();
                        fetch('/api/delete-suspect', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ suspect_id: suspectId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                cy.remove(node);
                                document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                                document.getElementById('total-connections').innerText = cy.edges().length;
                            } else {
                                alert(`Error: ${data.error}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while deleting the suspect.');
                        });
                    }
                }
                contextMenu.style.display = 'none';
            });
    
            // Close context menu on click elsewhere
            document.addEventListener('click', function(e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });
    
            // Initialize Selected Suspect
            selectedSuspect = null;
    
            // Modal elements for Dork Suspect
            var dorkModal = document.getElementById('dork-modal');
            var dorkForm = document.getElementById('dork-form');
            var dorkCancelBtn = document.getElementById('dork-cancel-button');
    
            // Handle Dork Suspect form submission
            dorkForm.addEventListener('submit', function(e) {
                e.preventDefault();
    
                var searchAll = document.getElementById('search-all').value;
                var searchEngines = [];
                if (document.getElementById('google').checked) {
                    searchEngines.push('google');
                }
                if (document.getElementById('bing').checked) {
                    searchEngines.push('bing');
                }
    
                if (searchEngines.length === 0) {
                    alert('Please select at least one search engine.');
                    return;
                }
    
                if (!dorkingSuspect) {
                    alert('No suspect selected for dorking.');
                    return;
                }
    
                var dorkData = {
                    suspect_id: dorkingSuspect.id,
                    search_all: searchAll === 'yes',
                    search_engines: searchEngines
                };
    
                fetch('/api/dork-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dorkData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dorking initiated for ${dorkingSuspect.label}.`);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
    
                        pollForResults(dorkingSuspect.id, dorkingSuspect.label);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while initiating dorking.');
                });
    
                dorkModal.style.display = 'none';
                dorkForm.reset();
            });
    
            // Close Dork Modal on 'Cancel'
            dorkCancelBtn.addEventListener('click', function() {
                dorkModal.style.display = 'none';
                dorkForm.reset();
            });
    
            // Modal for Existing Suspect
            var existingSuspectModal = document.getElementById('existing-suspect-modal');
            var useExistingBtn = document.getElementById('use-existing');
            var scrapeAgainBtn = document.getElementById('scrape-again');
    
            function openExistingSuspectModal(suspectId, suspectName) {
                existingSuspectModal.style.display = 'block';
                document.getElementById('existing-suspect-name').innerText = suspectName;
                existingSuspectId = suspectId;
            }
    
            useExistingBtn.addEventListener('click', function() {
                existingSuspectModal.style.display = 'none';
                fetch(`/api/get-results?suspect_id=${encodeURIComponent(existingSuspectId)}`)
                .then(response => response.json())
                .then(resultsData => {
                    if (resultsData.status === 'success') {
                        processResultsData(resultsData.data, existingSuspectId, existingSuspectName);
                        alert(`Loaded existing data for ${existingSuspectName}.`);
                        document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                        document.getElementById('total-connections').innerText = cy.edges().length;
                    } else {
                        alert(`Error: ${resultsData.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error fetching existing data:', error);
                    alert('An error occurred while fetching existing data.');
                });
            });
    
            scrapeAgainBtn.addEventListener('click', function() {
                existingSuspectModal.style.display = 'none';
                fetch('/api/dork-suspect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        suspect_id: existingSuspectId,
                        search_all: true,
                        search_engines: ['google', 'bing']
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Dorking initiated again for ${existingSuspectName}.`);
                        apiRequestCount += 1;
                        document.getElementById('api-requests').innerText = apiRequestCount;
    
                        pollForResults(existingSuspectId, existingSuspectName);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while initiating dorking.');
                });
            });
    
            // Profile icon functionality
            var profileIcon = document.getElementById('profile-icon');
            var accountModal = document.getElementById('account-modal');
            var logoutButtonModal = document.getElementById('logout-button-modal');
    
            profileIcon.addEventListener('click', function() {
                accountModal.style.display = 'block';
            });
    
            logoutButtonModal.addEventListener('click', function() {
                accountModal.style.display = 'none';
                alert('Logged out successfully.');
                // Implement actual logout functionality here
            });
    
            // Close modals when clicking outside of the content
            window.onclick = function(event) {
                if (event.target == addModal) {
                    addModal.style.display = 'none';
                    form.reset();
                }
                if (event.target == detailModal) {
                    detailModal.style.display = 'none';
                }
                if (event.target == accountModal) {
                    accountModal.style.display = 'none';
                }
                if (event.target == dorkModal) {
                    dorkModal.style.display = 'none';
                    dorkForm.reset();
                }
                if (event.target == existingSuspectModal) {
                    existingSuspectModal.style.display = 'none';
                }
                if (event.target == imagePreviewModal) {
                    imagePreviewModal.style.display = 'none';
                }
                if (!contextMenu.contains(event.target)) {
                    contextMenu.style.display = 'none';
                }
            };
    
            function pollForResults(suspectId, suspectName, interval = 5000, maxAttempts = 20) {
                let attempts = 0;
                let pollingMessage = document.getElementById('polling-message');
                if (pollingMessage) {
                    pollingMessage.innerText = `Scraping in progress for ${suspectName}...`;
                    pollingMessage.style.display = 'block';
                } else {
                    console.warn('Polling message element not found.');
                }
    
                function checkResults() {
                    attempts++;
                    fetch(`/api/get-results?suspect_id=${encodeURIComponent(suspectId)}`)
                    .then(response => response.json())
                    .then(resultsData => {
                        if (resultsData.status === 'success') {
                            pollingMessage.style.display = 'none';
                            processResultsData(resultsData.data, suspectId, suspectName);
                            alert(`Data loaded for ${suspectName}.`);
                            document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                            document.getElementById('total-connections').innerText = cy.edges().length;
                        } else {
                            if (attempts < maxAttempts) {
                                setTimeout(checkResults, interval);
                            } else {
                                pollingMessage.style.display = 'none';
                                alert(`Failed to load results for ${suspectName} after multiple attempts.`);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching results:', error);
                        if (attempts < maxAttempts) {
                            setTimeout(checkResults, interval);
                        } else {
                            pollingMessage.style.display = 'none';
                            alert(`An error occurred while fetching results for ${suspectName}.`);
                        }
                    });
                }
    
                checkResults();
            }
    
            /**
             * Function to process results data and add to Cytoscape graph
             * @param {Object} data - The results data from the backend
             * @param {string} suspectId - The ID of the suspect
             * @param {string} suspectName - The name of the suspect
             */
            function processResultsData(data, suspectId, suspectName) {
                try {
                    // Define styling based on category is handled by stylesheet

                    // Check if the main suspect node exists; if not, add it
                    if (cy.getElementById(suspectId).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: suspectId,
                                label: suspectName,
                                type: 'suspect'
                            }
                        });
                    }

                    let newNodes = [];
                    let newEdges = [];

                    for (let site_name in data) {
                        let news_items = data[site_name];
                        const methodNodeId = `method-${site_name.toLowerCase().replace(/\s+/g, '-')}`;

                        if (cy.getElementById(methodNodeId).length === 0) {
                            newNodes.push({
                                group: 'nodes',
                                data: {
                                    id: methodNodeId,
                                    label: site_name,
                                    type: 'method'
                                }
                            });

                            newEdges.push({
                                group: 'edges',
                                data: {
                                    source: suspectId,
                                    target: methodNodeId,
                                    type: 'method-connection'
                                }
                            });
                        }

                        let domainGroups = {};

                        news_items.forEach(item => {
                            try {
                                let url = new URL(item.url);
                                let domain = url.hostname.replace('www.', '') || 'unknown_domain';
                                if (!domainGroups[domain]) {
                                    domainGroups[domain] = [];
                                }
                                domainGroups[domain].push(item);
                            } catch (e) {
                                console.error('Invalid URL:', item.url);
                                let domain = 'unknown_domain';
                                if (!domainGroups[domain]) {
                                    domainGroups[domain] = [];
                                }
                                domainGroups[domain].push(item);
                            }
                        });

                        for (let domain in domainGroups) {
                            let domainItems = domainGroups[domain];
                            const domainNodeId = `domain-${site_name.toLowerCase().replace(/\s+/g, '-')}-${domain.replace(/\./g, '-')}`;

                            if (cy.getElementById(domainNodeId).length === 0) {
                                newNodes.push({
                                    group: 'nodes',
                                    data: {
                                        id: domainNodeId,
                                        label: domain,
                                        type: 'domain',
                                        method: site_name.toLowerCase().replace(/\s+/g, '-')
                                    }
                                });

                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: methodNodeId,
                                        target: domainNodeId,
                                        type: 'domain-connection'
                                    }
                                });
                            }

                            domainItems.forEach(item => {
                                let nodeId = generateUniqueId();

                                let label = item.headline || item.url || 'Unknown';

                                // Avoid adding duplicate nodes based on a unique attribute (e.g., url)
                                if (item.url && cy.nodes(`[data-url="${item.url}"]`).length > 0) {
                                    return;
                                }

                                let nodeData = {
                                    id: nodeId,
                                    label: label,
                                    url: item.url || '',
                                    date: item.date || '',
                                    category: site_name || 'N/A',
                                    domain: domain,
                                    method: site_name.toLowerCase().replace(/\s+/g, '-'),
                                    type: 'result',
                                    image_url: '' // Not available in current data
                                };

                                newNodes.push({
                                    group: 'nodes',
                                    data: nodeData
                                });

                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: domainNodeId,
                                        target: nodeId,
                                        type: 'result-connection'
                                    }
                                });
                            });
                        }
                    }

                    newNodes = Array.isArray(newNodes) ? newNodes : [newNodes];
                    newEdges = Array.isArray(newEdges) ? newEdges : [newEdges];

                    cy.batch(() => {
                        cy.add(newNodes);
                        cy.add(newEdges);
                    });

                    cy.layout({ name: 'cose', padding: 10, animate: true }).run();

                    document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                    document.getElementById('total-connections').innerText = cy.edges().length;

                    console.log('Results data processed and graph updated successfully.');
                } catch (error) {
                    console.error('Error processing results data:', error);
                    alert('An error occurred while processing the results data.');
                }
            }

            /**
             * Function to generate a unique ID for nodes
             * @returns {string} - A unique identifier string
             */
            function generateUniqueId() {
                return 'node-' + Math.random().toString(36).substr(2, 9);
            }

            // Add Connection functionality
            document.getElementById('add-connection').addEventListener('click', function() {
                var selectedNodes = cy.$('node:selected');
                if (selectedNodes.length === 2) {
                    var source = selectedNodes[0].id();
                    var target = selectedNodes[1].id();

                    fetch('/api/add-connection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source_id: source, target_id: target })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            cy.add({
                                group: 'edges',
                                data: { source: source, target: target }
                            });
                            cy.layout({ name: 'cose', padding: 10, animate: true }).run();
                            document.getElementById('total-connections').innerText = cy.edges().length;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while adding the connection.');
                    });
                } else {
                    alert('Please select exactly two suspects to create a connection.');
                }
            });

            // Web Scraping Tool
            document.getElementById('web-scraping').addEventListener('click', function() {
                if (selectedSuspect && selectedSuspect.type === 'suspect') {
                    fetch('/api/scrape-web', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suspect_id: selectedSuspect.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Web scraping initiated for ${selectedSuspect.label}.`);
                            apiRequestCount += 1;
                            document.getElementById('api-requests').innerText = apiRequestCount;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while initiating web scraping.');
                    });
                } else {
                    alert('Please select a suspect to perform web scraping.');
                }
            });

            // API Integration Tool
            document.getElementById('api-integration').addEventListener('click', function() {
                if (selectedSuspect && selectedSuspect.type === 'suspect') {
                    fetch('/api/api-integration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suspect_id: selectedSuspect.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`API integration initiated for ${selectedSuspect.label}.`);
                            apiRequestCount += 1;
                            document.getElementById('api-requests').innerText = apiRequestCount;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while initiating API integration.');
                    });
                } else {
                    alert('Please select a suspect to perform API integration.');
                }
            });

            // Social Media Scraping Tool
            document.getElementById('social-media-scraping').addEventListener('click', function() {
                if (selectedSuspect && selectedSuspect.type === 'suspect') {
                    fetch('/api/social-media-scraping', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suspect_id: selectedSuspect.id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Social media scraping initiated for ${selectedSuspect.label}.`);
                            apiRequestCount += 1;
                            document.getElementById('api-requests').innerText = apiRequestCount;
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while initiating social media scraping.');
                    });
                } else {
                    alert('Please select a suspect to perform social media scraping.');
                }
            });

            // Dork Suspect Tool
            document.getElementById('dork-suspect').addEventListener('click', function() {
                var selectedNodes = cy.nodes('node:selected');
                var selectedSuspects = selectedNodes.filter(node => node.data('type') === 'suspect');

                if (selectedSuspects.length > 0) {
                    var suspectNode = selectedSuspects[0];
                    dorkingSuspect = suspectNode.data();
                    dorkModal.style.display = 'block';
                } else {
                    alert('Please select a suspect to continue.');
                }
            });

            // Handle context menu delete via selection
            // Already handled in context menu
            // Profile icon functionality
            var profileIcon = document.getElementById('profile-icon');
            var accountModal = document.getElementById('account-modal');
            var logoutButtonModal = document.getElementById('logout-button-modal');

            profileIcon.addEventListener('click', function() {
                accountModal.style.display = 'block';
            });

            logoutButtonModal.addEventListener('click', function() {
                accountModal.style.display = 'none';
                alert('Logged out successfully.');
                // Implement actual logout functionality here
            });

            // Close modals when clicking outside of the content
            window.onclick = function(event) {
                if (event.target == addModal) {
                    addModal.style.display = 'none';
                    form.reset();
                }
                if (event.target == detailModal) {
                    detailModal.style.display = 'none';
                }
                if (event.target == accountModal) {
                    accountModal.style.display = 'none';
                }
                if (event.target == dorkModal) {
                    dorkModal.style.display = 'none';
                    dorkForm.reset();
                }
                if (event.target == existingSuspectModal) {
                    existingSuspectModal.style.display = 'none';
                }
                if (event.target == imagePreviewModal) {
                    imagePreviewModal.style.display = 'none';
                }
                if (!contextMenu.contains(event.target)) {
                    contextMenu.style.display = 'none';
                }
            };

            function pollForResults(suspectId, suspectName, interval = 5000, maxAttempts = 20) {
                let attempts = 0;
                let pollingMessage = document.getElementById('polling-message');
                if (pollingMessage) {
                    pollingMessage.innerText = `Scraping in progress for ${suspectName}...`;
                    pollingMessage.style.display = 'block';
                } else {
                    console.warn('Polling message element not found.');
                }

                function checkResults() {
                    attempts++;
                    fetch(`/api/get-results?suspect_id=${encodeURIComponent(suspectId)}`)
                    .then(response => response.json())
                    .then(resultsData => {
                        if (resultsData.status === 'success') {
                            pollingMessage.style.display = 'none';
                            processResultsData(resultsData.data, suspectId, suspectName);
                            alert(`Data loaded for ${suspectName}.`);
                            document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                            document.getElementById('total-connections').innerText = cy.edges().length;
                        } else {
                            if (attempts < maxAttempts) {
                                setTimeout(checkResults, interval);
                            } else {
                                pollingMessage.style.display = 'none';
                                alert(`Failed to load results for ${suspectName} after multiple attempts.`);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching results:', error);
                        if (attempts < maxAttempts) {
                            setTimeout(checkResults, interval);
                        } else {
                            pollingMessage.style.display = 'none';
                            alert(`An error occurred while fetching results for ${suspectName}.`);
                        }
                    });
                }

                checkResults();
            }

            /**
             * Function to process results data and add to Cytoscape graph
             * @param {Object} data - The results data from the backend
             * @param {string} suspectId - The ID of the suspect
             * @param {string} suspectName - The name of the suspect
             */
            function processResultsData(data, suspectId, suspectName) {
                try {
                    // Define styling based on category is handled by stylesheet

                    // Check if the main suspect node exists; if not, add it
                    if (cy.getElementById(suspectId).length === 0) {
                        cy.add({
                            group: 'nodes',
                            data: {
                                id: suspectId,
                                label: suspectName,
                                type: 'suspect'
                            }
                        });
                    }

                    let newNodes = [];
                    let newEdges = [];

                    for (let site_name in data) {
                        let news_items = data[site_name];
                        const methodNodeId = `method-${site_name.toLowerCase().replace(/\s+/g, '-')}`;

                        if (cy.getElementById(methodNodeId).length === 0) {
                            newNodes.push({
                                group: 'nodes',
                                data: {
                                    id: methodNodeId,
                                    label: site_name,
                                    type: 'method'
                                }
                            });

                            newEdges.push({
                                group: 'edges',
                                data: {
                                    source: suspectId,
                                    target: methodNodeId,
                                    type: 'method-connection'
                                }
                            });
                        }

                        let domainGroups = {};

                        news_items.forEach(item => {
                            try {
                                let url = new URL(item.url);
                                let domain = url.hostname.replace('www.', '') || 'unknown_domain';
                                if (!domainGroups[domain]) {
                                    domainGroups[domain] = [];
                                }
                                domainGroups[domain].push(item);
                            } catch (e) {
                                console.error('Invalid URL:', item.url);
                                let domain = 'unknown_domain';
                                if (!domainGroups[domain]) {
                                    domainGroups[domain] = [];
                                }
                                domainGroups[domain].push(item);
                            }
                        });

                        for (let domain in domainGroups) {
                            let domainItems = domainGroups[domain];
                            const domainNodeId = `domain-${site_name.toLowerCase().replace(/\s+/g, '-')}-${domain.replace(/\./g, '-')}`;

                            if (cy.getElementById(domainNodeId).length === 0) {
                                newNodes.push({
                                    group: 'nodes',
                                    data: {
                                        id: domainNodeId,
                                        label: domain,
                                        type: 'domain',
                                        method: site_name.toLowerCase().replace(/\s+/g, '-')
                                    }
                                });

                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: methodNodeId,
                                        target: domainNodeId,
                                        type: 'domain-connection'
                                    }
                                });
                            }

                            domainItems.forEach(item => {
                                let nodeId = generateUniqueId();

                                let label = item.headline || item.url || 'Unknown';

                                // Avoid adding duplicate nodes based on a unique attribute (e.g., url)
                                if (item.url && cy.nodes(`[data-url="${item.url}"]`).length > 0) {
                                    return;
                                }

                                let nodeData = {
                                    id: nodeId,
                                    label: label,
                                    url: item.url || '',
                                    date: item.date || '',
                                    category: site_name || 'N/A',
                                    domain: domain,
                                    method: site_name.toLowerCase().replace(/\s+/g, '-'),
                                    type: 'result',
                                    image_url: '' // Not available in current data
                                };

                                newNodes.push({
                                    group: 'nodes',
                                    data: nodeData
                                });

                                newEdges.push({
                                    group: 'edges',
                                    data: {
                                        source: domainNodeId,
                                        target: nodeId,
                                        type: 'result-connection'
                                    }
                                });
                            });
                        }
                    }

                    newNodes = Array.isArray(newNodes) ? newNodes : [newNodes];
                    newEdges = Array.isArray(newEdges) ? newEdges : [newEdges];

                    cy.batch(() => {
                        cy.add(newNodes);
                        cy.add(newEdges);
                    });

                    cy.layout({ name: 'cose', padding: 10, animate: true }).run();

                    document.getElementById('total-suspects').innerText = cy.nodes().filter(node => node.data('type') === 'suspect').length;
                    document.getElementById('total-connections').innerText = cy.edges().length;

                    console.log('Results data processed and graph updated successfully.');
                } catch (error) {
                    console.error('Error processing results data:', error);
                    alert('An error occurred while processing the results data.');
                }
            }

            /**
             * Function to generate a unique ID for nodes
             * @returns {string} - A unique identifier string
             */
            function generateUniqueId() {
                return 'node-' + Math.random().toString(36).substr(2, 9);
            }

            window.addEventListener('resize', function() {
                cy.resize();
                cy.fit();
            });
        });
    </script>
</body>
</html>
